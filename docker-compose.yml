services:
  shelfarr:
    build:
      context: .
      args:
        GIT_COMMIT: ${GIT_COMMIT:-unknown}
    container_name: shelfarr
    restart: unless-stopped
    ports:
      - "3000:80"
    volumes:
      # Persist SQLite databases, Active Storage files, and logs
      - ./data/storage:/rails/storage
      # Output directories - audiobooks and ebooks libraries
      - /mnt/media/audiobooks:/audiobooks
      - /mnt/media/ebooks:/ebooks
      # SABnzbd completed downloads folder for post-processing
      - /mnt/media/Torrents/Completed:/downloads
    environment:
      - RAILS_ENV=production
      - RAILS_MASTER_KEY=${RAILS_MASTER_KEY}
      - SOLID_QUEUE_IN_PUMA=1
      # Alternatively, if you're using credentials.yml.enc, set SECRET_KEY_BASE directly:
      # - SECRET_KEY_BASE=${SECRET_KEY_BASE}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80/up"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
