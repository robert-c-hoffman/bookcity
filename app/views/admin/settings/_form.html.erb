<%= form_with url: bulk_update_admin_settings_path, method: :patch, data: { settings_form_target: "form" } do |form| %>
  <div class="flex justify-between items-center mb-8">
    <h1 class="font-bold text-4xl text-white">Settings</h1>
    <div class="flex items-center gap-4">
      <span data-settings-form-target="status" class="text-sm text-gray-500 hidden">Saving...</span>
      <%= form.submit "Save All", class: "rounded-md px-4 py-2 bg-blue-600 hover:bg-blue-500 text-white cursor-pointer" %>
    </div>
  </div>

  <% @settings_by_category.each do |category, settings| %>
    <div class="bg-gray-900 rounded-lg border border-gray-800 mb-6">
      <div class="px-6 py-4 border-b border-gray-800">
        <h2 class="font-bold text-xl text-white"><%= SettingsService::CATEGORIES[category] || category.titleize %></h2>
      </div>
      <div class="p-6 space-y-6">
        <% settings.each do |key, data| %>
          <div class="flex flex-col md:flex-row md:items-start gap-4">
            <div class="md:w-1/3">
              <label for="settings_<%= key %>" class="font-medium text-gray-300"><%= key.to_s.titleize %></label>
              <p class="text-sm text-gray-500"><%= data[:definition][:description] %></p>
            </div>
            <div class="md:w-2/3">
              <% case data[:definition][:type] %>
              <% when "boolean" %>
                <label class="inline-flex items-center cursor-pointer">
                  <%= form.check_box "settings[#{key}]", { checked: data[:value] == true || data[:value] == "true", id: "settings_#{key}", class: "w-5 h-5 rounded border-gray-600 bg-gray-700 text-blue-600 focus:ring-blue-500 focus:ring-2", data: { action: "change->settings-form#autoSave" } }, "true", "false" %>
                </label>
              <% when "integer" %>
                <%= form.number_field "settings[#{key}]", value: data[:value], id: "settings_#{key}", class: "w-full rounded-md border border-gray-700 bg-gray-800 text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 px-3 py-2", data: { action: "change->settings-form#autoSave" } %>
              <% when "json" %>
                <%= form.text_field "settings[#{key}]", value: data[:value].is_a?(Array) ? data[:value].join(', ') : data[:value], id: "settings_#{key}", class: "w-full rounded-md border border-gray-700 bg-gray-800 text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 px-3 py-2", data: { action: "change->settings-form#autoSave" } %>
                <p class="mt-1 text-xs text-gray-500">For multiple values, use comma-separated format (e.g., en, fr, de)</p>
              <% else %>
                <% if key.to_s.end_with?("_library_id") && @audiobookshelf_libraries.any? %>
                  <%# Library picker dropdown when Audiobookshelf is configured %>
                  <% library_options = @audiobookshelf_libraries.map { |lib| ["#{lib.name} (#{lib.media_type})", lib.id] } %>
                  <%= form.select "settings[#{key}]", options_for_select([["Select a library...", ""]] + library_options, data[:value]), {}, id: "settings_#{key}", class: "w-full rounded-md border border-gray-700 bg-gray-800 text-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 px-3 py-2", data: { action: "change->settings-form#autoSave" } %>
                <% elsif key.to_s.end_with?("_library_id") %>
                  <%# Library ID text field when Audiobookshelf is not configured %>
                  <%= form.text_field "settings[#{key}]", value: data[:value], id: "settings_#{key}", placeholder: "Configure Audiobookshelf URL and API key first", class: "w-full rounded-md border border-gray-700 bg-gray-800 text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 px-3 py-2", data: { action: "change->settings-form#autoSave" } %>
                  <p class="mt-1 text-xs text-yellow-500">Enter Audiobookshelf URL and API key above to select from available libraries</p>
                <% elsif key.to_s == "oidc_default_role" %>
                  <%= form.select "settings[#{key}]", options_for_select([["User", "user"], ["Admin", "admin"]], data[:value]), {}, id: "settings_#{key}", class: "w-full rounded-md border border-gray-700 bg-gray-800 text-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 px-3 py-2", data: { action: "change->settings-form#autoSave" } %>
                <% elsif key.to_s.include?("password") || key.to_s.include?("api_key") || key.to_s.include?("secret") %>
                  <%= form.password_field "settings[#{key}]", value: data[:value], placeholder: data[:value].present? ? "********" : "", id: "settings_#{key}", class: "w-full rounded-md border border-gray-700 bg-gray-800 text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 px-3 py-2", data: { action: "change->settings-form#autoSave" } %>
                <% else %>
                  <%= form.text_field "settings[#{key}]", value: data[:value], id: "settings_#{key}", class: "w-full rounded-md border border-gray-700 bg-gray-800 text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 px-3 py-2", data: { action: "change->settings-form#autoSave" } %>
                <% end %>
              <% end %>
            </div>
          </div>
        <% end %>

        <%# Test connection buttons for services - using link_to with turbo-method to avoid nested forms %>
        <% if category == "anna_archive" %>
          <div class="flex flex-col md:flex-row md:items-start gap-4 pt-4 border-t border-gray-800">
            <div class="md:w-1/3">
              <span class="font-medium text-gray-300">Test FlareSolverr</span>
              <p class="text-sm text-gray-500">Verify FlareSolverr is reachable (required to bypass DDoS protection)</p>
            </div>
            <div class="md:w-2/3">
              <%= link_to "Test FlareSolverr Connection", test_flaresolverr_admin_settings_path, data: { turbo_method: :post, turbo_preserve_scroll: true }, class: "inline-block rounded-md px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white text-sm cursor-pointer" %>
            </div>
          </div>
        <% elsif category == "prowlarr" %>
          <div class="flex flex-col md:flex-row md:items-start gap-4 pt-4 border-t border-gray-800">
            <div class="md:w-1/3">
              <span class="font-medium text-gray-300">Test Connection</span>
              <p class="text-sm text-gray-500">Verify Prowlarr is reachable</p>
            </div>
            <div class="md:w-2/3">
              <%= link_to "Test Prowlarr Connection", test_prowlarr_admin_settings_path, data: { turbo_method: :post, turbo_preserve_scroll: true }, class: "inline-block rounded-md px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white text-sm cursor-pointer" %>
            </div>
          </div>
        <% elsif category == "audiobookshelf" %>
          <div class="flex flex-col md:flex-row md:items-start gap-4 pt-4 border-t border-gray-800">
            <div class="md:w-1/3">
              <span class="font-medium text-gray-300">Test Connection</span>
              <p class="text-sm text-gray-500">Verify Audiobookshelf is reachable</p>
            </div>
            <div class="md:w-2/3">
              <%= link_to "Test Audiobookshelf Connection", test_audiobookshelf_admin_settings_path, data: { turbo_method: :post, turbo_preserve_scroll: true }, class: "inline-block rounded-md px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white text-sm cursor-pointer" %>
            </div>
          </div>
        <% elsif category == "hardcover" %>
          <div class="flex flex-col md:flex-row md:items-start gap-4 pt-4 border-t border-gray-800">
            <div class="md:w-1/3">
              <span class="font-medium text-gray-300">Test Connection</span>
              <p class="text-sm text-gray-500">Verify Hardcover API token is valid</p>
            </div>
            <div class="md:w-2/3">
              <%= link_to "Test Hardcover Connection", test_hardcover_admin_settings_path, data: { turbo_method: :post, turbo_preserve_scroll: true }, class: "inline-block rounded-md px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white text-sm cursor-pointer" %>
            </div>
          </div>
        <% elsif category == "oidc" %>
          <div class="flex flex-col md:flex-row md:items-start gap-4 pt-4 border-t border-gray-800">
            <div class="md:w-1/3">
              <span class="font-medium text-gray-300">Test Configuration</span>
              <p class="text-sm text-gray-500">Verify OIDC provider discovery works</p>
            </div>
            <div class="md:w-2/3">
              <%= link_to "Test OIDC Configuration", test_oidc_admin_settings_path, data: { turbo_method: :post, turbo_preserve_scroll: true }, class: "inline-block rounded-md px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white text-sm cursor-pointer" %>
            </div>
          </div>
        <% end %>
      </div>
    </div>
  <% end %>
<% end %>
